# نظام إدارة المبيعات CRM

نظام إدارة علاقات العملاء (CRM) متطور ومتكامل مصمم خصيصاً لإدارة المبيعات وتوزيع العملاء على فريق المبيعات مع دعم كامل للغة العربية والتحديثات الفورية عبر جميع الأجهزة.

## المميزات الرئيسية

### 🔐 نظام المصادقة والصلاحيات
- تسجيل دخول آمن باستخدام Supabase Auth
- دعم دورين: مدير (Admin) وموظف (Employee)
- حماية الصفحات والبيانات باستخدام Row Level Security (RLS)
- إعادة توجيه تلقائي حسب صلاحيات المستخدم

### 👥 إدارة الموظفين (للمدير)
- إضافة وتعديل وحذف الموظفين
- تفعيل وإيقاف حسابات الموظفين
- تعيين الأدوار والصلاحيات
- عرض إحصائيات أداء كل موظف
- البحث والتصفية المتقدمة

### 📞 توزيع الأرقام والعملاء
- رفع ملفات Excel/CSV لاستيراد أرقام العملاء
- إدخال يدوي للأرقام
- **منع تكرار الأرقام تلقائياً** - النظام يتحقق من عدم وجود رقم مكرر قبل الإضافة
- **تطبيع الأرقام تلقائياً** - تصحيح صيغة الأرقام للتوافق مع WhatsApp
- توزيع تلقائي أو يدوي على الموظفين
- تتبع حالة كل عميل (جديد، تم الاتصال، مهتم، غير مهتم، تم البيع)

### 💬 طابور WhatsApp
- استقبال الأرقام الواردة من WhatsApp
- تعيين الأرقام للموظفين
- تتبع حالة كل رقم في الطابور
- إحصائيات شاملة للطابور

### 📝 الملاحظات والتذكيرات
- **إضافة ملاحظات وتذكيرات للعملاء** من قبل الموظفين
- **المدير يرى جميع الملاحظات والتذكيرات** من لوحة التحكم الخاصة به
- **إشعارات فورية** عند إضافة تذكير جديد
- تصنيف الملاحظات (عامة، تذكير، مهمة)
- البحث والتصفية حسب الموظف والعميل

### 💰 حاسبة التمويل
- حساب أقساط السيارات بدقة
- دعم أنواع متعددة من التمويل (بنكي، تأجيري، شخصي)
- جدول أقساط تفصيلي شهري
- حساب الفائدة والرسوم الإدارية
- إمكانية المشاركة والطباعة

### 📄 عروض الأسعار
- إنشاء عروض أسعار احترافية
- إضافة بنود متعددة لكل عرض
- حساب تلقائي للإجمالي والضريبة
- ربط العروض بالعملاء
- تتبع حالة كل عرض

### 📊 التقارير والتحليلات
- تقارير شاملة عن أداء النظام
- رسوم بيانية تفاعلية (أعمدة، خطوط، دائرية)
- تحليل أداء الموظفين
- توزيع حالات العملاء
- النشاط اليومي للنظام
- تصدير التقارير بصيغة JSON

### 📁 إدارة الملفات
- **رفع ومشاركة الملفات** (صور، مستندات، PDF)
- **إرسال رسائل مع مرفقات** للعملاء
- البحث والتصفية حسب نوع الملف
- عرض معلومات الملف (الحجم، التاريخ، الرافع)
- تحميل وحذف الملفات

### 🔄 المزامنة الفورية
- **تحديثات فورية عبر جميع الأجهزة** باستخدام Supabase Realtime
- **دعم الأجهزة المتعددة** - أي جهاز على نفس الشبكة يحصل على التحديثات فوراً
- مؤشر حالة الاتصال
- عرض المستخدمين المتصلين حالياً
- مزامنة تلقائية للبيانات

### 📱 متوافق مع الجوال
- تصميم متجاوب بالكامل (Responsive Design)
- يعمل بكفاءة على الهواتف والأجهزة اللوحية
- واجهة مستخدم محسّنة للشاشات الصغيرة

### 🌙 الوضع الليلي
- دعم كامل للوضع الليلي (Dark Mode)
- تباين ألوان محسّن للقراءة
- تبديل سهل بين الوضعين

### ⚙️ الإعدادات
- تخصيص اسم الشركة والشعار
- إعدادات النظام العامة
- إدارة الإشعارات
- نسخ احتياطي واستعادة البيانات

## التقنيات المستخدمة

- **Next.js 15** - إطار عمل React للتطبيقات الحديثة
- **TypeScript** - للكتابة الآمنة والموثوقة
- **Supabase** - قاعدة بيانات PostgreSQL مع مصادقة وتحديثات فورية
- **Tailwind CSS v4** - للتصميم السريع والمتجاوب
- **shadcn/ui** - مكتبة مكونات UI حديثة
- **Recharts** - للرسوم البيانية التفاعلية
- **date-fns** - لمعالجة التواريخ
- **Lucide Icons** - أيقونات حديثة وجميلة

## البدء السريع

### المتطلبات الأساسية

- Node.js 18 أو أحدث
- حساب Supabase (مجاني)

### التثبيت

1. **استنساخ المشروع**
\`\`\`bash
git clone <repository-url>
cd sales-crm
\`\`\`

2. **تثبيت الحزم**
\`\`\`bash
npm install
\`\`\`

3. **إعداد Supabase**
   - قم بإنشاء مشروع جديد على [Supabase](https://supabase.com)
   - انسخ `SUPABASE_URL` و `SUPABASE_ANON_KEY` من إعدادات المشروع

4. **إعداد متغيرات البيئة**
   - في v0، اذهب إلى قسم "Vars" في الشريط الجانبي
   - أضف المتغيرات التالية:
     - `NEXT_PUBLIC_SUPABASE_URL`
     - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
     - `NEXT_PUBLIC_DEV_SUPABASE_REDIRECT_URL` (للتطوير المحلي)

5. **تشغيل سكريبتات قاعدة البيانات**
   - في v0، اذهب إلى مجلد `scripts`
   - قم بتشغيل السكريبتات بالترتيب:
     1. `001_setup_rls_policies.sql`
     2. `002_add_indexes_and_functions.sql`
     3. `003_create_admin_user.sql`
     4. `004_add_files_table.sql`
     5. `005_add_demo_users_and_data.sql` (اختياري - لإضافة بيانات تجريبية)

6. **تشغيل المشروع**
\`\`\`bash
npm run dev
\`\`\`

7. **الوصول إلى النظام**
   - افتح المتصفح على `http://localhost:3000`
   - سجل الدخول باستخدام أحد الحسابات التالية:

### 🔑 بيانات تسجيل الدخول

#### حساب المدير
- **البريد الإلكتروني:** `admin@crm.com`
- **كلمة المرور:** `admin123`

#### حسابات الموظفين التجريبية (بعد تشغيل السكريبت 005)

| الاسم | البريد الإلكتروني | كلمة المرور | المنصب |
|------|-------------------|-------------|---------|
| أحمد محمد | `ahmed@demo.crm.com` | `ahmed2024` | مندوب مبيعات |
| فاطمة علي | `fatima@demo.crm.com` | `fatima2024` | مندوبة مبيعات |
| محمد حسن | `mohammed@demo.crm.com` | `mohammed2024` | مندوب مبيعات |
| سارة خالد | `sara@demo.crm.com` | `sara2024` | مندوبة مبيعات |

> ⚠️ **تحذير أمني:** يُرجى تغيير جميع كلمات المرور الافتراضية فوراً بعد أول تسجيل دخول، خاصة في بيئة الإنتاج!

### 📊 البيانات التجريبية

عند تشغيل السكريبت `005_add_demo_users_and_data.sql`، سيتم إضافة:
- ✅ 4 موظفين تجريبيين
- ✅ 20 عميل موزعين على الموظفين
- ✅ 30 ملاحظة وتذكير
- ✅ 10 عروض أسعار بحالات مختلفة
- ✅ إشعارات فورية للاختبار

هذه البيانات مفيدة لاختبار النظام وفهم كيفية عمله قبل إضافة بيانات حقيقية.

## هيكل المشروع

\`\`\`
sales-crm/
├── app/
│   ├── admin/              # صفحات لوحة تحكم المدير
│   │   ├── employees/      # إدارة الموظفين
│   │   ├── distribution/   # توزيع الأرقام
│   │   ├── whatsapp-queue/ # طابور الواتساب
│   │   ├── notes/          # الملاحظات والتذكيرات
│   │   ├── files/          # إدارة الملفات
│   │   ├── reports/        # التقارير والتحليلات
│   │   └── settings/       # الإعدادات
│   ├── employee/           # صفحات لوحة تحكم الموظف
│   │   ├── customers/      # إدارة العملاء
│   │   ├── notes/          # الملاحظات والتذكيرات
│   │   ├── financing/      # حاسبة التمويل
│   │   ├── quotes/         # عروض الأسعار
│   │   └── files/          # الملفات المشتركة
│   ├── auth/               # صفحات المصادقة
│   └── layout.tsx          # التخطيط الرئيسي
├── components/
│   ├── admin/              # مكونات لوحة المدير
│   ├── employee/           # مكونات لوحة الموظف
│   └── ui/                 # مكونات UI العامة
├── lib/
│   ├── supabase/           # إعدادات Supabase
│   ├── auth.ts             # دوال المصادقة
│   ├── phone-utils.ts      # دوال معالجة الأرقام
│   └── realtime-sync.ts    # دوال المزامنة الفورية
├── scripts/                # سكريبتات قاعدة البيانات
└── hooks/                  # React Hooks مخصصة
\`\`\`

## قاعدة البيانات

### الجداول الرئيسية

- **employees** - بيانات الموظفين والصلاحيات
- **customers** - بيانات العملاء والحالات
- **phone_numbers** - أرقام الهواتف للتوزيع
- **notes** - الملاحظات والتذكيرات
- **quotations** - عروض الأسعار
- **files** - الملفات المرفوعة
- **notifications** - الإشعارات
- **settings** - إعدادات النظام

### الأمان

- **Row Level Security (RLS)** مفعّل على جميع الجداول
- سياسات أمان محكمة لكل دور
- المدير يرى جميع البيانات
- الموظف يرى بياناته فقط

## الميزات المتقدمة

### منع تكرار الأرقام
النظام يستخدم دالة `normalize_phone_number` لتطبيع الأرقام وقيد UNIQUE لمنع التكرار:
\`\`\`sql
CREATE UNIQUE INDEX idx_customers_phone_normalized 
ON customers(normalize_phone_number(phone));
\`\`\`

### تطبيع الأرقام تلقائياً
يتم تحويل جميع الأرقام إلى الصيغة الدولية (+966xxxxxxxxx) تلقائياً:
- إزالة المسافات والرموز
- إضافة رمز الدولة (+966)
- التحقق من صحة الرقم

### المزامنة الفورية
استخدام Supabase Realtime للتحديثات الفورية:
\`\`\`typescript
const channel = supabase
  .channel('table-changes')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'customers' }, 
    (payload) => {
      // تحديث البيانات فوراً
    }
  )
  .subscribe()
\`\`\`

### إرسال الملفات مع الرسائل
يمكن للموظفين إرسال رسائل WhatsApp مع مرفقات:
- رفع الملف إلى Supabase Storage
- الحصول على رابط عام
- إرسال الرابط مع الرسالة

## الدعم والمساعدة

### المشاكل الشائعة

**مشكلة: لا يمكن تسجيل الدخول**
- تأكد من تشغيل سكريبت `003_create_admin_user.sql`
- تحقق من متغيرات البيئة

**مشكلة: التحديثات الفورية لا تعمل**
- تأكد من تفعيل Realtime في Supabase
- تحقق من سياسات RLS

**مشكلة: لا يمكن رفع الملفات**
- تأكد من تشغيل سكريبت `004_add_files_table.sql`
- تحقق من إعدادات Storage في Supabase

## التطوير المستقبلي

- [ ] تكامل مع WhatsApp Business API
- [ ] إشعارات Push للجوال
- [ ] تقارير PDF قابلة للتخصيص
- [ ] لوحة تحكم تحليلية متقدمة
- [ ] تكامل مع أنظمة CRM أخرى
- [ ] تطبيق جوال (React Native)

## الترخيص

هذا المشروع مرخص تحت رخصة MIT.

## المساهمة

نرحب بالمساهمات! يرجى فتح Issue أو Pull Request.

---

 نظام CRM متكامل للمبيعات 🚀
